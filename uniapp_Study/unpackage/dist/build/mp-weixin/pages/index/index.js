"use strict";const e=require("../../common/vendor.js"),s={data:()=>({houseDescription:"",images:[],maxImages:30,communityName:"",area:"",houseTypeRange:[["1房","2房","3房","4房","5房","6房","7房","8房","9房"],["0厅","1厅","2厅","3厅","4厅","5厅","6厅","7厅","8厅","9厅"],["0卫","1卫","2卫","3卫","4卫","5卫","6卫","7卫","8卫","9卫"]],houseTypeIndex:[0,0,0],currentFloor:"",totalFloors:"",totalPrice:"",isUploading:!1,selectedImageBase64Set:new Set}),methods:{chooseImage(){const s=this.maxImages-this.images.length;e.index.chooseImage({count:s,sizeType:["compressed"],sourceType:["album"],success:async e=>{for(const s of e.tempFilePaths){const e=await this.getBase64(s);this.selectedImageBase64Set.has(e)||(this.selectedImageBase64Set.add(e),this.images.push({path:s,base64:e}))}}})},getBase64:s=>new Promise(((a,t)=>{e.index.getFileSystemManager().readFile({filePath:s,encoding:"base64",success:e=>{a(e.data)},fail:e=>{t(e)}})})),previewImage(s){e.index.previewImage({urls:this.images.map((e=>e.path)),current:s})},deleteImage(e){const s=this.images[e];this.images.splice(e,1),this.selectedImageBase64Set.delete(s.base64)},async uploadImages(){this.isUploading=!0;try{const s=this.images.map((async e=>{const s=await this.compressImage(e.path),a=await this.uploadImage(s);return JSON.parse(a.data).imageUrls})),a=(await Promise.all(s)).flat(),t={description:this.houseDescription,community:this.communityName,area:this.area,layout:`${this.houseTypeRange[0][this.houseTypeIndex[0]]}${this.houseTypeRange[1][this.houseTypeIndex[1]]}${this.houseTypeRange[2][this.houseTypeIndex[2]]}`,floor:`${this.currentFloor}层/共${this.totalFloors}层`,total_price:this.totalPrice,images:a,is_video_generated:!1};console.log(t.layout);const o=await e.index.request({url:"http://101.126.149.86:8000/add_housing/",method:"POST",data:t});o&&200===o.statusCode?(e.index.switchTab({url:"/pages/listingform/listingform"}),this.houseDescription="",this.images=[],this.communityName="",this.area="",this.houseTypeIndex=[0,0,0],this.currentFloor="",this.totalFloors="",this.totalPrice="",this.selectedImageBase64Set.clear(),this.isUploading=!1,e.index.showToast({title:"房源添加成功",icon:"success"})):(e.index.showToast({title:"房源添加失败",icon:"none"}),console.error("房源添加失败",o))}catch(s){e.index.showToast({title:"上传失败",icon:"none"}),console.error("上传失败",s)}},compressImage:s=>new Promise(((a,t)=>{e.index.compressImage({src:s,quality:60,success:e=>{a(e.tempFilePath)},fail:e=>{t(e)}})})),uploadImage:s=>new Promise(((a,t)=>{e.index.uploadFile({url:"http://101.126.149.86:8000/upload/image",filePath:s,name:"files",success:e=>{a(e)},fail:e=>{t(e)}})})),onHouseTypeChange(e){this.houseTypeIndex=e.detail.value}}};const a=e._export_sfc(s,[["render",function(s,a,t,o,i,n){return e.e({a:i.houseDescription,b:e.o((e=>i.houseDescription=e.detail.value)),c:e.f(i.images,((s,a,t)=>({a:s.path,b:e.o((e=>n.previewImage(a)),a),c:e.o((e=>n.deleteImage(a)),a),d:a}))),d:i.images.length<i.maxImages},i.images.length<i.maxImages?{e:e.o(((...e)=>n.chooseImage&&n.chooseImage(...e)))}:{},{f:i.communityName,g:e.o((e=>i.communityName=e.detail.value)),h:i.area,i:e.o((e=>i.area=e.detail.value)),j:e.t(i.houseTypeRange[0][i.houseTypeIndex[0]]),k:e.t(i.houseTypeRange[1][i.houseTypeIndex[1]]),l:e.t(i.houseTypeRange[2][i.houseTypeIndex[2]]),m:i.houseTypeRange,n:i.houseTypeIndex,o:e.o(((...e)=>n.onHouseTypeChange&&n.onHouseTypeChange(...e))),p:i.currentFloor,q:e.o((e=>i.currentFloor=e.detail.value)),r:i.totalFloors,s:e.o((e=>i.totalFloors=e.detail.value)),t:i.totalPrice,v:e.o((e=>i.totalPrice=e.detail.value)),w:e.t(i.isUploading?"上传中...":"发布"),x:i.isUploading,y:e.o(((...e)=>n.uploadImages&&n.uploadImages(...e)))})}]]);wx.createPage(a);
